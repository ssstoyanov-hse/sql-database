# Лабораторная работа по курсу БД ![Deadline](https://img.shields.io/date/1618444799) ![Progress](https://progress-bar.dev/84/)

Автор **[@Никита Мушка](https://github.com/mushka-n)**, **[@Станислав Стоянов](https://github.com/ssstoyanov)**

## Вариант 1

### Уровень 1

---

1. Дана схема базы данных в виде следующих отношений. С помощью операторов SQL создать логическую структуру
   соответствующих таблиц для хранения в СУБД, используя известные средства поддержания целостности (NOT NULL, UNIQUE, и
   т.д.). Обосновать выбор типов данных и используемые средства поддержания целостности. При выборе подходящих типов
   данных использовать информацию о конкретных значениях полей БД

Покупатель

|ИДЕНТИФИКАТОР|ФАМИЛИЯ|РАЙОН ПРОЖИВАНИЯ|СКИДКА, %|
|:----:|:----:|:----:|:----:|

Магазин

|ИДЕНТИФИКАТОР|НАЗВАНИЕ|РАЙОН РАЗМЕЩЕНИЯ|КОММИСИОННЫЕ, %|
|:----:|:----:|:----:|:----:|

Книги

|ИДЕНТИФИКАТОР|НАЗВАНИЕ|СТОИМОСТЬ, РУБ.|СКЛАД|КОЛ-ВО|
|:----:|:----:|:----:|:----:|:----:|

Покупка

|НОМЕР ЗАКАЗА|ДАТА|ПРОДАВЕЦ|ПОКУПАТЕЛЬ|КНИГА|КОЛ-ВО|СУММА, РУБ|
|:----:|:----:|:----:|:----:|:----:|:----:|:----:|

```sql
create table ПОКУПАТЕЛЬ
(
    ИДЕНТИФИКАТОР      serial                                                   not null primary key,
    ФАМИЛИЯ            varchar(31)                                              not null,
    "РАЙОН ПРОЖИВАНИЯ" varchar(255)                                             not null,
    "СКИДКА, %"        smallint check ("СКИДКА, %" >= 0 AND "СКИДКА, %" <= 100) not null
);

create table МАГАЗИН
(
    ИДЕНТИФИКАТОР      serial                                                               not null primary key,
    НАЗВАНИЕ           varchar(31)                                                          not null,
    "РАЙОН РАЗМЕЩЕНИЯ" varchar(255)                                                         not null,
    "КОММИСИОННЫЕ, %"  smallint check ("КОММИСИОННЫЕ, %" >= 0 AND "КОММИСИОННЫЕ, %" <= 100) not null
);

create table КНИГИ
(
    ИДЕНТИФИКАТОР     serial                                not null primary key,
    НАЗВАНИЕ          varchar(255)                          not null,
    "СТОИМОСТЬ, РУБ." integer check ("СТОИМОСТЬ, РУБ." > 0) not null,
    СКЛАД             varchar(255)                          not null,
    "КОЛ-ВО"          integer check ("КОЛ-ВО" > 0)          not null
);


create table ПОКУПКА
(
    "НОМЕР ЗАКАЗА" serial                           not null primary key,
    ДАТА           varchar(10)                      not null,
    ПРОДАВЕЦ       serial                           not null references МАГАЗИН (ИДЕНТИФИКАТОР),
    ПОКУПАТЕЛЬ     serial                           not null references ПОКУПАТЕЛЬ (ИДЕНТИФИКАТОР),
    КНИГА          serial                           not null references КНИГИ (ИДЕНТИФИКАТОР),
    "КОЛ-ВО"       smallint check ("КОЛ-ВО" > 0)    not null,
    "СУММА, РУБ"   integer check ("СУММА, РУБ" > 0) not null
);
```

---

2. Ввести в ранее созданные таблицы конкретные данные. Использовать скрипт-файл из операторов INSERT или вспомогательную
   утилиту

```sql
insert into "ПОКУПАТЕЛЬ" ("ИДЕНТИФИКАТОР", "ФАМИЛИЯ", "РАЙОН ПРОЖИВАНИЯ", "СКИДКА, %")
values (001, 'Cидоров', 'Нижегородский', 10),
       (002, 'Потапов', 'Советский', 20),
       (003, 'Попов', 'Ленинский', 10),
       (004, 'Романова', 'Нижегородский', 10),
       (005, 'Миронов', 'Автозаводский', 15),
       (006, 'Попов', 'Советский', 0);

insert into "МАГАЗИН" ("ИДЕНТИФИКАТОР", "НАЗВАНИЕ", "РАЙОН РАЗМЕЩЕНИЯ", "КОММИСИОННЫЕ, %")
values (001, 'Знание', 'Автозаводский', 7),
       (002, 'Наука', 'Нижегородский', 8),
       (003, 'Книжный мир', 'Приокский', 6),
       (004, 'Книги', 'Сормовский', 9),
       (005, 'Книги', 'Советский', 7);

insert into "КНИГИ" ("ИДЕНТИФИКАТОР", "НАЗВАНИЕ", "СТОИМОСТЬ, РУБ.", "СКЛАД", "КОЛ-ВО")
values (001, 'Windows для чайников', 15000, 'Сормовский', 400),
       (002, 'Excel 5.0', 23000, 'Сормовский', 360),
       (003, 'Работа с Visual FoxPro', 32000, 'Нижегородский', 300),
       (004, 'Программирование в среде Delphi', 20000, 'Нижегородский', 100),
       (005, 'SQL', 47000, 'Автозаводский', 89),
       (006, 'Word 6.0 для Windows', 16000, 'Сормовский', 200),
       (007, 'Твой первый выход в Internet', 15000, 'Советский', 140);

insert into "ПОКУПКА" ("НОМЕР ЗАКАЗА", "ДАТА", "ПРОДАВЕЦ", "ПОКУПАТЕЛЬ", "КНИГА", "КОЛ-ВО", "СУММА, РУБ")
values (10011, 'Январь', 001, 006, 003, 2, 64000),
       (10012, 'Январь', 001, 006, 002, 2, 46000),
       (10013, 'Январь', 005, 005, 004, 4, 80000),
       (10014, 'Февраль', 001, 003, 003, 3, 96000),
       (10015, 'Февраль', 004, 006, 002, 1, 23000),
       (10016, 'Март', 001, 004, 007, 2, 30000),
       (10017, 'Март', 005, 006, 006, 3, 48000),
       (10018, 'Апрель', 001, 001, 003, 3, 96000),
       (10019, 'Апрель', 003, 003, 007, 2, 30000),
       (10020, 'Апрель', 005, 002, 002, 5, 115000),
       (10021, 'Апрель', 005, 002, 001, 3, 45000),
       (10022, 'Май', 002, 003, 007, 2, 30000),
       (10023, 'Май', 002, 004, 003, 1, 32000),
       (10024, 'Май', 004, 003, 005, 1, 47000),
       (10025, 'Май', 004, 006, 003, 4, 60000),
       (10026, 'Май', 005, 001, 005, 3, 80000),
       (10027, 'Июнь', 003, 002, 006, 2, 32000);
```

---

3. Используя оператор SELECT создать запрос для вывода всех строк каждой таблицы. Проверить правильность ввода. При
   необходимости произвести коррекцию значений операторами INSERT, UPDATE, DELETE.

```sql
select *
from "ПОКУПАТЕЛЬ";
select *
from "МАГАЗИН";
select *
from "КНИГИ";
select *
from "ПОКУПКА";
```

---

4. Создать запросы для вывода:

- всех различных названий и стоимостей книг

```sql
select distinct "НАЗВАНИЕ", "СТОИМОСТЬ, РУБ."
from "КНИГИ"
```

- всех различных районов, в которых проживают покупатели

```sql
select distinct "РАЙОН ПРОЖИВАНИЯ"
from "ПОКУПАТЕЛЬ";
```

- всех различных месяцев, когда производились покупки

```sql
select distinct "ДАТА"
from "ПОКУПКА"
```

---

5. Создать запросы для получения информации о:

- о фамилиях и размере скидки всех покупателей, проживающих в Нижегородском районе

```sql
select "ФАМИЛИЯ", "СКИДКА, %"
from "ПОКУПАТЕЛЬ"
where "РАЙОН ПРОЖИВАНИЯ" = 'Нижегородский'
```

- о названиях магазинов Сормовского или Советского районов

```sql
select "НАЗВАНИЕ"
from "МАГАЗИН"
where "РАЙОН РАЗМЕЩЕНИЯ" = 'Советский'
   or "РАЙОН РАЗМЕЩЕНИЯ" = 'Сормовский'
```

- о названиях и стоимости книг, в которых встречается слово Windows, или стоящих более 20000 руб. Вывод результатов
  организовать по названию и убыванию цены книг

```sql
select "НАЗВАНИЕ", "СТОИМОСТЬ, РУБ."
from "КНИГИ"
where lower("НАЗВАНИЕ") like lower('%windows%')
   or "СТОИМОСТЬ, РУБ." > 20000
```

---

6. Для каждой покупки вывести следующие данные:

- фамилию покупателя и название магазина, где производилась покупка

```sql
select "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "МАГАЗИН"."НАЗВАНИЕ"
from "ПОКУПАТЕЛЬ",
     "МАГАЗИН",
     "ПОКУПКА"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."ПРОДАВЕЦ" = "МАГАЗИН"."ИДЕНТИФИКАТОР"
```

- дату, фамилию покупателя, скидку, название и количество купленных книг

```sql
select "ПОКУПКА"."ДАТА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПАТЕЛЬ"."СКИДКА, %", "КНИГИ"."НАЗВАНИЕ", "ПОКУПКА"."КОЛ-ВО"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."КНИГА" = "КНИГИ"."ИДЕНТИФИКАТОР"
```

---

7. Определить:

- номер заказа, фамилию покупателя и дату для покупок в которых было продано книг на сумму не меньшую чем 60000 руб

```sql
select "ПОКУПКА"."НОМЕР ЗАКАЗА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."ДАТА"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."КНИГА" = "КНИГИ"."ИДЕНТИФИКАТОР"
group by "ПОКУПКА"."НОМЕР ЗАКАЗА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."ДАТА"
having SUM("ПОКУПКА"."СУММА, РУБ") >= 60000
```  

- покупки, сделанные покупателем в своем районе не ранее марта месяца. Вывести фамилию покупателя, район, дату

```sql
select "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ", "ПОКУПКА"."ДАТА"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ",
     "МАГАЗИН"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."КНИГА" = "КНИГИ"."ИДЕНТИФИКАТОР"
  and "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ" = "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
  and ("ПОКУПКА"."ДАТА" LIKE 'Январь'
    or "ПОКУПКА"."ДАТА" LIKE 'Февраль')
```

Произвести сортировку

- магазины, расположенные в любом районе, кроме Автозаводского, где покупали книги те, у кого скидка от 10 до 15 %

```sql
select "МАГАЗИН".*
from "МАГАЗИН",
     "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "РАЙОН РАЗМЕЩЕНИЯ" not like 'Автозаводский'
  and "ПОКУПАТЕЛЬ"."СКИДКА, %" between 10 and 15
  and "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."ПРОДАВЕЦ" = "МАГАЗИН"."ИДЕНТИФИКАТОР"
order by "МАГАЗИН"."ИДЕНТИФИКАТОР", "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
```

- данные по покупке книг (название, район складирования, количество), приобретенных в районе складирования и
  содержащихся в запасе более 10 штук. Включить данные о стоимости и отсортировать по возрастанию

```sql
select "КНИГИ"."НАЗВАНИЕ", "КНИГИ"."СКЛАД", "КНИГИ"."КОЛ-ВО", "КНИГИ"."СТОИМОСТЬ, РУБ."
from "КНИГИ",
     "МАГАЗИН"
where "КНИГИ"."СКЛАД" = "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
  and "КНИГИ"."КОЛ-ВО" > 10;
```

---

8. Создать запрос для модификации всех значений столбца с суммарной величиной покупки, чтобы он содержал истинную сумму,
   оплачиваемую покупателем (с учетом скидки). Вывести новые значения

```sql
update "ПОКУПКА"
set "СУММА, РУБ" = "СУММА, РУБ" - "СУММА, РУБ" / 100 * (select "СКИДКА, %"
                                                        from "ПОКУПАТЕЛЬ"
                                                        where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР");
select *
from "ПОКУПКА";
```

---

9. Расширить таблицу с данными о покупке столбцом, содержащим величину комиссионных, получаемых магазином. Создать
   запрос для ввода конкретных значений во все строки таблицы покупок

```sql
alter table "ПОКУПКА"
    add column "КОМИСИОННЫЕ, РУБ" integer check ("СУММА, РУБ" >= 0) not null default 0;
update "ПОКУПКА"
set "КОМИСИОННЫЕ, РУБ" = "СУММА, РУБ" / 100 * (select "КОММИСИОННЫЕ, %"
                                               from "МАГАЗИН"
                                               where "ПОКУПКА"."ПРОДАВЕЦ" = "МАГАЗИН"."ИДЕНТИФИКАТОР");
select *
from "ПОКУПКА";
```

---

### Уровень 2

---

10. Используя операцию IN (NOT IN) реализовать следующие запросы:

- найти покупателей, которые не покупали книг в магазинах Нижегородского района в июне;

```sql
select "ПОКУПАТЕЛЬ"."ФАМИЛИЯ"
from "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "ПОКУПКА"."ПРОДАВЕЦ" NOT IN (002)
  and "ПОКУПКА"."ДАТА" NOT IN ('ИЮНЬ')
group by "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР";
```

- найти покупателей, покупавших книги в мае на сумму, меньшую чем купил Потапов в том же месяце;

```sql

```

- реализовать запросы заданий 7.а, 7.с.

```sql
select "ПОКУПКА"."НОМЕР ЗАКАЗА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."ДАТА"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" IN ("ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР")
  and "ПОКУПКА"."КНИГА" IN ("КНИГИ"."ИДЕНТИФИКАТОР")
group by "ПОКУПКА"."НОМЕР ЗАКАЗА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."ДАТА"
having SUM("ПОКУПКА"."СУММА, РУБ") >= 60000;

select "МАГАЗИН".*
from "МАГАЗИН",
     "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "РАЙОН РАЗМЕЩЕНИЯ" NOT IN ('Автозаводский')
  and "ПОКУПАТЕЛЬ"."СКИДКА, %" IN (10, 11, 12, 13, 14, 15)
  and "ПОКУПКА"."ПОКУПАТЕЛЬ" IN ("ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР")
  and "ПОКУПКА"."ПРОДАВЕЦ" IN ("МАГАЗИН"."ИДЕНТИФИКАТОР")
order by "МАГАЗИН"."ИДЕНТИФИКАТОР", "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ";
```

---

11. Используя операции ALL-ANY реализовать следующие запросы:

- определить покупателя, имеющего минимальную скидку среди тех, кто покупал книги на сумму не менее 50000руб.

```sql
select "ФАМИЛИЯ", "СКИДКА, %"
from "ПОКУПАТЕЛЬ"
where "ПОКУПАТЕЛЬ"."СКИДКА, %" <= All (
    select "ПОКУПАТЕЛЬ"."СКИДКА, %"
    from ПОКУПАТЕЛЬ,
         ПОКУПКА
    where "СУММА, РУБ" >= 50000);
```

- найти покупателя, покупавшего самое большое количество книг;

```sql
select "ФАМИЛИЯ", "КОЛ-ВО"
from "ПОКУПАТЕЛЬ",
     "ПОКУПКА" as P1
where P1."КОЛ-ВО" >= all (
    select P2."КОЛ-ВО"
    from ПОКУПКА as P2
    where P2."НОМЕР ЗАКАЗА" <> P1."НОМЕР ЗАКАЗА");
```

- запрос задания 7 (b)

```sql
select "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ", "ПОКУПКА"."ДАТА"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ",
     "МАГАЗИН"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."КНИГА" = "КНИГИ"."ИДЕНТИФИКАТОР"
  and "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ" = "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
  and "ПОКУПКА"."ДАТА" = ANY (
    select "ПОКУПКА"."ДАТА"
    from "ПОКУПКА"
    where "ПОКУПКА"."ДАТА" in ('Январь', 'Февраль'));
```

- какой из покупателей не покупавший книг в магазинах своего района, делал покупки на минимальную сумму.

```sql

```

---

12. Используя операцию UNION получить районы проживания покупателей и районы складирования книг.

```sql
select "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ"
from "ПОКУПАТЕЛЬ"
UNION
select "КНИГИ"."СКЛАД"
FROM "КНИГИ";
```

---

13. Используя операцию EXISTS (NOT EXISTS) реализовать нижеследующие запросы. В случае, если для текущего состояния БД
    запрос будет выдавать пустое множество строк, требуется указать какие добавления в БД необходимо провести.

- какой покупатель покупал все книги в магазине “Наука” или “Знание”;

```sql
select ФАМИЛИЯ
from ПОКУПАТЕЛЬ,
     ПОКУПКА
where not exists(
        select ФАМИЛИЯ
        from ПОКУПАТЕЛЬ,
             ПОКУПКА
        where ПОКУПКА.ПРОДАВЕЦ not In (001, 002));
```

- найти покупателей, покупавших книги во всех магазинах своего района до декабря;

```sql
select ФАМИЛИЯ, ИДЕНТИФИКАТОР
from ПОКУПАТЕЛЬ buyer
where exists(
              select purchase.ПОКУПАТЕЛЬ
              from ПОКУПКА purchase,
                   МАГАЗИН store
              where buyer."РАЙОН ПРОЖИВАНИЯ" = store."РАЙОН РАЗМЕЩЕНИЯ"
                and purchase.ДАТА <> 'Декабрь');
```

- определить покупателей, покупавших все книги, не продающиеся в магазине с максимальным значением комиссионных;

```sql

```

- найти среди покупателей тех, кто не покупал в мае книг со ценой более 25000руб. в магазинах с максимальным размером
  комиссионных.

```sql

```

---

14. Реализовать запросы с использованием агрегатных функций:

- получить среднюю стоимость покупок, сделанных в магазинах Нижегородского района

```sql
select sum("ПОКУПКА"."СУММА, РУБ") / count("ПОКУПКА"."СУММА, РУБ") as "СРЕДНЯЯ СТОИМОСТЬ"
from "ПОКУПКА"
```

- найти количество покупателей, покупавших книги в магазине “Наука”

```sql
select count("ПОКУПКА"."ПОКУПАТЕЛЬ")
from "ПОКУПКА",
     "МАГАЗИН"
where "ПОКУПКА"."ПРОДАВЕЦ" = "МАГАЗИН"."ИДЕНТИФИКАТОР"
  and "МАГАЗИН"."НАЗВАНИЕ" != 'Наука';
```

- найти покупателей имеющих скидку ниже средней

```sql
select *
from "ПОКУПАТЕЛЬ"
where (select avg("ПОКУПАТЕЛЬ"."СКИДКА, %") from "ПОКУПАТЕЛЬ") > "СКИДКА, %"
```  

- определить магазины, в которых покупало книги больше покупателей чем в магазине “Наука”

```sql

```

---

15. Используя средства группировки реализовать следующие запросы:

- вывести данные по суммарной стоимости книг, купленных в каждом магазине

```sql

```

- вывести отчет о суммарной стоимости всех купленных книг по районам, где расположены магазины

```sql

```

- получить сводную информацию о сумме всех покупок, произведенных каждым покупателем

```sql

```

- определить для каждого дня недели количество книг, купленных покупателями не из Советского района

```sql

```
